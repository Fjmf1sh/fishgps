<!DOCTYPE html>
<html>
<head>
  <title>AI GPS with Home & Walking Routes</title>
  <meta charset="utf-8">
  <style>
    html, body { margin: 0; height: 100%; font-family: sans-serif; }
    #map { height: 80%; }
    #assistant {
      height: 20%;
      background: #111;
      color: #0f0;
      overflow-y: auto;
      padding: 10px;
    }
    #input {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

<div id="map"></div>
<div id="assistant">
  <div><strong>AI Assistant:</strong> Type a destination or "home"</div>
</div>
<input id="input" placeholder="e.g., Starbucks, gas station, home" />

<script>
  let map, userMarker, routeLayer;
  let userCoords = null;

  const homeCoords = [33.6267376, -117.9122829];

  function initMap(lat, lon) {
    map = L.map('map').setView([lat, lon], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    userMarker = L.marker([lat, lon]).addTo(map).bindPopup("You are here").openPopup();

    navigator.geolocation.watchPosition(pos => {
      const { latitude, longitude } = pos.coords;
      userCoords = [latitude, longitude];
      userMarker.setLatLng(userCoords);
      map.setView([latitude, longitude]);
    });
  }

  navigator.geolocation.getCurrentPosition(position => {
    const { latitude, longitude } = position.coords;
    userCoords = [latitude, longitude];
    initMap(latitude, longitude);
  }, err => {
    alert("GPS denied. Using default location.");
    userCoords = [...homeCoords];
    initMap(...homeCoords);
  });

  const assistant = document.getElementById("assistant");
  const input = document.getElementById("input");

  input.addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
      const query = input.value.trim();
      if (!query) return;
      appendMessage("You: " + query);
      input.value = "";

      if (query.toLowerCase() === "home") {
        appendMessage("AI: Heading home...");
        routeTo(homeCoords[0], homeCoords[1]);
      } else {
        handleSearch(query);
      }
    }
  });

  function appendMessage(msg) {
    assistant.innerHTML += `<div>${msg}</div>`;
    assistant.scrollTop = assistant.scrollHeight;
  }

  function handleSearch(query) {
    if (!userCoords) {
      appendMessage("AI: Waiting for GPS...");
      return;
    }

    appendMessage("AI: Searching nearby for "" + query + ""...");

    const [lat, lon] = userCoords;
    const viewbox = `${lon-0.05},${lat+0.05},${lon+0.05},${lat-0.05}`;

    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&viewbox=${viewbox}&bounded=1`)
      .then(response => response.json())
      .then(results => {
        if (results.length === 0) {
          appendMessage("AI: Couldn't find anything nearby.");
          return;
        }

        const dest = results[0];
        const destLat = parseFloat(dest.lat);
        const destLon = parseFloat(dest.lon);
        appendMessage(`AI: Found ${dest.display_name}. Routing now...`);
        routeTo(destLat, destLon);
      });
  }

  function routeTo(destLat, destLon) {
    const [startLat, startLon] = userCoords;
    const routeURL = `https://router.project-osrm.org/route/v1/walking/${startLon},${startLat};${destLon},${destLat}?overview=full&geometries=geojson`;

    fetch(routeURL)
      .then(res => res.json())
      .then(data => {
        if (data.code !== "Ok") {
          appendMessage("AI: Routing failed.");
          return;
        }

        const route = data.routes[0].geometry;
        if (routeLayer) map.removeLayer(routeLayer);
        routeLayer = L.geoJSON(route).addTo(map);
        map.fitBounds(routeLayer.getBounds());
        appendMessage("AI: Route is now on the map.");
      });
  }
</script>

</body>
</html>
