<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI GPS Assistant with Global Search Option</title>
  <!-- Leaflet CSS (integrity attributes removed) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" crossorigin=""/>
  <style>
    html, body { margin: 0; padding: 0; height: 100vh; }
    #map { height: 60vh; width: 100%; }
    #assistant { height: 40vh; overflow-y: auto; background: #111; color: #0f0; padding: 10px; }
    #inputArea {
      display: flex;
      flex-direction: column;
      gap: 5px;
      padding: 10px;
    }
    #userInput { width: 100%; padding: 10px; box-sizing: border-box; }
    #globalToggle { margin-top: 5px; }
  </style>
</head>
<body>
<div id="map"></div>
<div id="assistant">
  <div id="messages"><strong>AI Assistant:</strong> Type a destination</div>
  <div id="inputArea">
    <input type="text" id="userInput" placeholder="e.g., Starbucks, gas station" />
    <label id="globalToggle">
      <input type="checkbox" id="globalSearch" /> Global Search
    </label>
  </div>
</div>

<!-- Leaflet JS (integrity attributes removed) -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>
<script>
  let map, userMarker, routeLayer;
  let userCoords = null;

  // Initialize the map using the user's location
  function initMap(lat, lon) {
    map = L.map('map').setView([lat, lon], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
    userMarker = L.marker([lat, lon]).addTo(map).bindPopup("You are here").openPopup();

    // Continuously update the user's location
    navigator.geolocation.watchPosition(
            pos => {
              const { latitude, longitude } = pos.coords;
              userCoords = [latitude, longitude];
              userMarker.setLatLng(userCoords);
              map.setView(userCoords);
            },
            err => { console.error(err); }
    );
  }

  // Get the user's initial location, or use a default if permission is denied
  navigator.geolocation.getCurrentPosition(
          position => {
            const { latitude, longitude } = position.coords;
            userCoords = [latitude, longitude];
            initMap(latitude, longitude);
          },
          err => {
            alert("GPS denied. Using default location.");
            userCoords = [0, 0];
            initMap(0, 0);
          }
  );

  // Process search input on Enter key
  const userInput = document.getElementById('userInput');
  const globalSearchCheckbox = document.getElementById('globalSearch');
  userInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      processQuery();
    }
  });

  function processQuery() {
    const query = userInput.value.trim();
    if (!query) return;
    addMessage("User", query);
    userInput.value = "";
    handleSearch(query);
  }

  function addMessage(sender, text) {
    const messagesDiv = document.getElementById('messages');
    const msgElem = document.createElement('div');
    msgElem.innerHTML = `<strong>${sender}:</strong> ${text}`;
    messagesDiv.appendChild(msgElem);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // Perform the search using the Nominatim API
  function handleSearch(query) {
    if (!userCoords) {
      addMessage("AI", "Waiting for GPS...");
      return;
    }
    addMessage("AI", `Searching for "${query}"...`);
    const [lat, lon] = userCoords;

    let apiUrl;
    if (globalSearchCheckbox.checked) {
      // Global search: No viewbox restrictions.
      apiUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
    } else {
      // Local search: Restrict results to a larger local area.
      const viewbox = `${lon - 0.2},${lat + 0.2},${lon + 0.2},${lat - 0.2}`;
      apiUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&viewbox=${viewbox}&bounded=1`;
    }

    fetch(apiUrl)
            .then(response => response.json())
            .then(results => {
              if (results.length === 0) {
                addMessage("AI", "Couldn't find that location.");
                return;
              }
              const dest = results[0];
              const destLat = parseFloat(dest.lat);
              const destLon = parseFloat(dest.lon);
              addMessage("AI", `Found: ${dest.display_name}. Routing now...`);
              routeTo(destLat, destLon);
            })
            .catch(err => {
              console.error(err);
              addMessage("AI", "Error during search.");
            });
  }

  // Draw the route using the OSRM API (walking profile)
  function routeTo(destLat, destLon) {
    const [startLat, startLon] = userCoords;
    const routeURL = `https://router.project-osrm.org/route/v1/walking/${startLon},${startLat};${destLon},${destLat}?overview=full&geometries=geojson`;
    fetch(routeURL)
            .then(res => res.json())
            .then(data => {
              if (data.code !== "Ok") {
                addMessage("AI", "Routing failed.");
                return;
              }
              const route = data.routes[0].geometry;
              if (routeLayer) {
                map.removeLayer(routeLayer);
              }
              routeLayer = L.geoJSON(route).addTo(map);
              map.fitBounds(routeLayer.getBounds());
              addMessage("AI", "Route displayed on map.");
            })
            .catch(err => {
              console.error(err);
              addMessage("AI", "Error during routing.");
            });
  }
</script>
</body>
</html>
